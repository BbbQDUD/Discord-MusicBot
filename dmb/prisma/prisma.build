#!/bin/bash

EXECUTOR=bun
DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"

ok() { # Print a green [OK]
    local string="$1"
    echo -e "\033[1;32m[OK]\033[0m $string"
}

info() { # Print a cyan [INFO]
    local string="$1"
    echo -e "\033[1;36m[INFO]\033[0m $string"
}

prepend() {
    local string="$1"
    local file="$2"
    printf '%s\n%s' "$string" "$(cat $file)" >$file
}

info "Building prisma schema..."

# Sometimes the script fails inexplicably due to some race condition, so we try until it works
while ! $EXECUTOR $DIR/builder.ts 2> /dev/null; do
    sleep 0.1
done

prepend "// DO NOT MODIFY THIS FILE MANUALLY
// This file was autogenerated by schemix in \`./${DIR##*/}/builder.ts\`.
// Use the TS scripts in \`./${DIR##*/}/models/\` to modify the schema
// run \`$EXECUTOR db:generate\` to rebuild the schema
" "${DIR}/schema.prisma"

ok "Prisma schema built successfully"
